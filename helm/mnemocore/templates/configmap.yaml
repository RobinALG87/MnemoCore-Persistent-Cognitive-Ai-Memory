{{/*
MnemoCore ConfigMap - HAIM Configuration
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mnemocore.configmap.fullname" . }}
  labels:
    {{- include "mnemocore.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
data:
  config.yaml: |
    # HAIM Configuration - Generated by Helm Chart
    # MnemoCore Phase {{ .Values.mnemocore.config.version }}

    haim:
      version: "{{ .Values.mnemocore.config.version }}"
      dimensionality: {{ .Values.mnemocore.config.dimensionality }}

      # Vector encoding
      encoding:
        mode: "{{ .Values.mnemocore.config.encoding.mode }}"
        token_method: "{{ .Values.mnemocore.config.encoding.token_method }}"

      # Memory tier thresholds
      tiers:
        hot:
          max_memories: {{ .Values.mnemocore.config.tiers.hot.max_memories }}
          ltp_threshold_min: {{ .Values.mnemocore.config.tiers.hot.ltp_threshold_min }}
          eviction_policy: "{{ .Values.mnemocore.config.tiers.hot.eviction_policy }}"

        warm:
          max_memories: {{ .Values.mnemocore.config.tiers.warm.max_memories }}
          ltp_threshold_min: {{ .Values.mnemocore.config.tiers.warm.ltp_threshold_min }}
          consolidation_interval_hours: {{ .Values.mnemocore.config.tiers.warm.consolidation_interval_hours }}
          storage_backend: "{{ .Values.mnemocore.config.tiers.warm.storage_backend }}"

        cold:
          storage_backend: "{{ .Values.mnemocore.config.tiers.cold.storage_backend }}"
          compression: "{{ .Values.mnemocore.config.tiers.cold.compression }}"
          archive_threshold_days: {{ .Values.mnemocore.config.tiers.cold.archive_threshold_days }}

      # LTP (Long-Term Potentiation) decay parameters
      ltp:
        initial_importance: {{ .Values.mnemocore.config.ltp.initial_importance }}
        decay_lambda: {{ .Values.mnemocore.config.ltp.decay_lambda }}
        permanence_threshold: {{ .Values.mnemocore.config.ltp.permanence_threshold }}
        half_life_days: {{ .Values.mnemocore.config.ltp.half_life_days }}

      # Hysteresis (prevent boundary thrashing between tiers)
      hysteresis:
        promote_delta: {{ .Values.mnemocore.config.hysteresis.promote_delta }}
        demote_delta: {{ .Values.mnemocore.config.hysteresis.demote_delta }}

      # Redis Configuration
      redis:
        {{- if .Values.redis.url }}
        url: "{{ .Values.redis.url }}"
        {{- else }}
        url: "redis://{{ include "mnemocore.redis.fullname" . }}:{{ .Values.redis.service.port }}/0"
        {{- end }}
        stream_key: "haim:subconscious"
        max_connections: 10
        socket_timeout: 5

      # Qdrant Configuration
      qdrant:
        {{- if .Values.qdrant.url }}
        url: "{{ .Values.qdrant.url }}"
        {{- else }}
        url: "http://{{ include "mnemocore.qdrant.fullname" . }}:{{ .Values.qdrant.service.httpPort }}"
        {{- end }}
        collection_hot: "{{ .Values.qdrant.collections.hot.name }}"
        collection_warm: "{{ .Values.qdrant.collections.warm.name }}"
        binary_quantization: {{ .Values.qdrant.collections.hot.binaryQuantization }}
        always_ram: {{ .Values.qdrant.collections.hot.alwaysRam }}
        hnsw_m: {{ .Values.qdrant.collections.hot.hnswM }}
        hnsw_ef_construct: {{ .Values.qdrant.collections.hot.hnswEfConstruct }}

      # GPU Configuration
      gpu:
        enabled: {{ .Values.mnemocore.config.gpu.enabled }}
        device: "{{ .Values.mnemocore.config.gpu.device }}"
        batch_size: {{ .Values.mnemocore.config.gpu.batch_size }}
        fallback_to_cpu: {{ .Values.mnemocore.config.gpu.fallback_to_cpu }}

      # Observability
      observability:
        metrics_port: {{ .Values.mnemocore.config.observability.metrics_port }}
        log_level: "{{ .Values.mnemocore.config.observability.log_level }}"
        structured_logging: {{ .Values.mnemocore.config.observability.structured_logging }}

      # Persistence paths
      paths:
        data_dir: "{{ .Values.mnemocore.config.paths.data_dir }}"
        memory_file: "{{ .Values.mnemocore.config.paths.memory_file }}"
        codebook_file: "{{ .Values.mnemocore.config.paths.codebook_file }}"
        concepts_file: "{{ .Values.mnemocore.config.paths.concepts_file }}"
        synapses_file: "{{ .Values.mnemocore.config.paths.synapses_file }}"
        warm_mmap_dir: "{{ .Values.mnemocore.config.paths.warm_mmap_dir }}"
        cold_archive_dir: "{{ .Values.mnemocore.config.paths.cold_archive_dir }}"

      # MCP (Model Context Protocol) bridge
      mcp:
        enabled: {{ .Values.mnemocore.config.mcp.enabled }}
        transport: "{{ .Values.mnemocore.config.mcp.transport }}"
        host: "{{ .Values.mnemocore.config.mcp.host }}"
        port: {{ .Values.mnemocore.config.mcp.port }}
        api_base_url: "{{ .Values.mnemocore.config.mcp.api_base_url }}"
        timeout_seconds: {{ .Values.mnemocore.config.mcp.timeout_seconds }}
        allow_tools:
          {{- range .Values.mnemocore.config.mcp.allow_tools }}
          - "{{ . }}"
          {{- end }}
